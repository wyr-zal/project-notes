# Gateway é‰´æƒå…¨å±€è¿‡æ»¤å™¨ï¼ˆAuthGlobalFilterï¼‰

---

## ä¸€ã€è¿™ä¸ªç±»è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ

åœ¨ **å¾®æœåŠ¡ç½‘å…³ï¼ˆSpring Cloud Gatewayï¼‰å±‚**ï¼Œéœ€è¦ç»Ÿä¸€å®Œæˆï¼š

- æ˜¯å¦éœ€è¦ç™»å½•æ ¡éªŒ
- Token æ˜¯å¦åˆæ³•
- ç”¨æˆ·èº«ä»½è§£æ
- ç”¨æˆ·ä¿¡æ¯å‘ä¸‹æ¸¸æœåŠ¡é€ä¼ 

ğŸ‘‰ **AuthGlobalFilter å°±æ˜¯æ•´ä¸ªç³»ç»Ÿâ€œç™»å½•é‰´æƒçš„ç¬¬ä¸€é“é—¨â€**

---

## äºŒã€æ•´ä½“èŒè´£ä¸€å¥è¯è¯´æ˜

> åœ¨è¯·æ±‚è¿›å…¥å¾®æœåŠ¡ç³»ç»Ÿä¹‹å‰ï¼Œ  
> ç”± Gateway æ ¡éªŒ JWT æ˜¯å¦åˆæ³•ï¼Œ  
> å¹¶å°†è§£æå‡ºçš„ userId æ”¾å…¥è¯·æ±‚å¤´ï¼Œ  
> ä¾›åç»­å¾®æœåŠ¡ä½¿ç”¨ã€‚

---

## ä¸‰ã€æ•´ä½“æ‰§è¡Œæµç¨‹ï¼ˆé‡ç‚¹ï¼‰

```text
å®¢æˆ·ç«¯è¯·æ±‚
â†’ Gateway æ¥æ”¶è¯·æ±‚
â†’ AuthGlobalFilter.filter()
â†’ æ˜¯å¦æ˜¯ç™½åå•è·¯å¾„ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ ç›´æ¥æ”¾è¡Œ
    â””â”€ å¦ â†’ æ ¡éªŒ token
            â”œâ”€ æ— æ•ˆ â†’ è¿”å› 401
            â””â”€ æœ‰æ•ˆ â†’ è§£æ userId
                    â†’ header å†™å…¥ user-info
                    â†’ æ”¾è¡Œåˆ°ä¸‹æ¸¸æœåŠ¡
```

---

## å››ã€ä¸ºä»€ä¹ˆæ”¾åœ¨ Gatewayï¼Ÿ

å› ä¸ºï¼š

* Gateway æ˜¯ **æ‰€æœ‰è¯·æ±‚çš„å…¥å£**
* å¯ä»¥ç»Ÿä¸€åšï¼š

  * ç™»å½•æ ¡éªŒ
  * é‰´æƒ
  * ç”¨æˆ·ä¿¡æ¯è§£æ
* é¿å…æ¯ä¸ªå¾®æœåŠ¡é‡å¤å†™ token æ ¡éªŒé€»è¾‘

ğŸ‘‰ **èŒè´£ä¸‹æ²‰ï¼ŒæœåŠ¡æ›´å¹²å‡€**

---

## äº”ã€å…³é”®æ¥å£è¯´æ˜

```java
public class AuthGlobalFilter implements GlobalFilter, Ordered
```

### GlobalFilter

* Gateway æä¾›çš„ **å…¨å±€è¿‡æ»¤å™¨**
* å¯¹ **æ‰€æœ‰è·¯ç”±è¯·æ±‚ç”Ÿæ•ˆ**

### Ordered

* æ§åˆ¶è¿‡æ»¤å™¨æ‰§è¡Œé¡ºåº
* æ•°å­—è¶Šå°ï¼Œè¶Šæ—©æ‰§è¡Œ

```java
@Override
public int getOrder() {
    return 1;
}
```

---

## å…­ã€æ ¸å¿ƒé€»è¾‘é€æ­¥æ‹†è§£

### 1ï¸âƒ£ è·å–è¯·æ±‚å¯¹è±¡

```java
ServerHttpRequest request = exchange.getRequest();
```

* Gateway ä½¿ç”¨çš„æ˜¯ **WebFlux**
* è¯·æ±‚å¯¹è±¡æ˜¯å“åº”å¼çš„ `ServerHttpRequest`

---

### 2ï¸âƒ£ æ˜¯å¦ä¸ºç™½åå•è·¯å¾„ï¼ˆä¸éœ€è¦ç™»å½•ï¼‰

```java
if (isExcluded(request.getPath().toString())) {
    return chain.filter(exchange);
}
```

ç™½åå•ä½œç”¨ï¼š

* ç™»å½•æ¥å£
* æ³¨å†Œæ¥å£
* å…¬å…±æ¥å£
* é™æ€èµ„æº

é¿å…æ‰€æœ‰æ¥å£éƒ½å¼ºåˆ¶æ ¡éªŒ token

---

### 3ï¸âƒ£ ä»è¯·æ±‚å¤´è·å– token

```java
List<String> headers = request.getHeaders().get("authorization");
```

* token æ”¾åœ¨ `authorization` è¯·æ±‚å¤´ä¸­
* ä¸å‰ç«¯ã€JWT è§„èŒƒä¿æŒä¸€è‡´

---

### 4ï¸âƒ£ æ ¡éªŒå¹¶è§£æ JWT

```java
Long userId = jwtTool.parseToken(token);
```

* token åˆæ³• â†’ è¿”å› userId
* token éæ³• / è¿‡æœŸ â†’ æŠ› UnauthorizedException

---

### 5ï¸âƒ£ token éæ³•çš„å¤„ç†æ–¹å¼

```java
response.setStatusCode(HttpStatus.UNAUTHORIZED);
return response.setComplete();
```

* ç›´æ¥è¿”å› 401
* è¯·æ±‚ä¸ä¼šè¿›å…¥ä»»ä½•å¾®æœåŠ¡
* ç½‘å…³å±‚ç›´æ¥æ‹¦æˆª

---

### 6ï¸âƒ£ å‘ä¸‹æ¸¸æœåŠ¡é€ä¼ ç”¨æˆ·ä¿¡æ¯ï¼ˆæ ¸å¿ƒï¼‰

```java
ServerWebExchange swe = exchange.mutate()
    .request(builder -> builder.header("user-info", userInfo))
    .build();
```

ä½œç”¨ï¼š

* å°† userId å†™å…¥è¯·æ±‚å¤´
* ä¸‹æ¸¸æœåŠ¡å¯é€šè¿‡æ‹¦æˆªå™¨è§£æ user-info
* å®ç° **ç”¨æˆ·ä¸Šä¸‹æ–‡é€ä¼ **

---

### 7ï¸âƒ£ æ”¾è¡Œè¯·æ±‚

```java
return chain.filter(swe);
```

---

## ä¸ƒã€isExcluded æ–¹æ³•è¯´æ˜

```java
private boolean isExcluded(String path)
```

* ä½¿ç”¨ `AntPathMatcher`
* æ”¯æŒï¼š

  * `/login/**`
  * `/public/**`
* ä» `AuthProperties` è¯»å–é…ç½®

---

## å…«ã€å’Œä¸‹æ¸¸æœåŠ¡çš„é…åˆå…³ç³»

### Gateway åšçš„äº‹

```text
token â†’ userId â†’ header(user-info)
```

### å¾®æœåŠ¡åšçš„äº‹

```text
header(user-info)
â†’ UserInfoInterceptor
â†’ UserContext.setUser()
```

ğŸ‘‰ **ä¸¤å±‚èŒè´£æ¸…æ™°åˆ†ç¦»**

---

## ä¹ã€å¸¸è§é—®é¢˜ & é£é™©ç‚¹

### âŒ ç™½åå•é…ç½®é”™è¯¯

* ç™»å½•æ¥å£è¢«æ‹¦æˆª
* æ°¸è¿œè¿”å› 401

---

### âŒ user-info æœªé€ä¼ 

* ä¸‹æ¸¸æœåŠ¡ `UserContext.getUser()` ä¸º null
* ä¸šåŠ¡é€»è¾‘å¼‚å¸¸

---

### âŒ Gateway ä¸åšé‰´æƒï¼ŒæœåŠ¡å†…åš

* ä»£ç é‡å¤
* å®‰å…¨ä¸å¯æ§
* ç»´æŠ¤æˆæœ¬é«˜

---

## åã€é¢è¯•é€Ÿè®°æ€»ç»“

> Gateway ä½¿ç”¨ GlobalFilter ç»Ÿä¸€æ ¡éªŒ JWTï¼Œ
> å¯¹ç™½åå•è·¯å¾„æ”¾è¡Œï¼Œ
> å¯¹éç™½åå•è·¯å¾„è§£æ tokenï¼Œ
> å¹¶å°† userId å†™å…¥è¯·æ±‚å¤´ï¼Œ
> å®ç°ç»Ÿä¸€é‰´æƒå’Œç”¨æˆ·ä¿¡æ¯é€ä¼ ã€‚

---

## åä¸€ã€è®°å¿†å£è¯€

```text
ç½‘å…³å…ˆéªŒ token
åˆæ³•æ‰æ”¾è¡Œ
userId å†™è¯·æ±‚å¤´
æœåŠ¡åªç®¡ç”¨
```